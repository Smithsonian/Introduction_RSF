---
title: "Animating Animal Movements"
author: "Jared Stabach, Smithsonian Conservation Biology Institute"
date: '`r format(Sys.time(), "%d %B %Y")`'
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: 
      collapsed: true
      smooth_scroll: true
    number_sections: false
    #theme: united
    #highlight: tango
pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<a href="https://github.com/Smithsonian/Wildebeest_RSF.git" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

# Introduction
Visualizing an animal's movement patterns is one of the best ways to engage with the general public.  In addition to providing important content for social media, visualizing the movements of animals (especially when multiple animals are tagged at the same time) can provide valuable information to generate addressable hypotheses and potential research questions.  

One of the simplest ways to animate an animal's movement pathway (in my opinion) is by using the [moveVis](https://cran.r-project.org/web/packages/moveVis/index.html) package. The instructions that follow are based on steps described by the package architect, Jakob Schwalb-Willmann.

## Load Libraries
```{r Animation Libraries, message=FALSE, warning=FALSE}
# Remove everything from memory
rm(list=ls())

# Make sure required libraries are loaded
library(raster)
library(rgdal)
library(move)
library(moveVis)
library(ggplot2)
library(dplyr)
library(lubridate)

# TimeZone and Projection for resulting animation
Timezone1 <- "UTC"
Timezone2 <- "Africa/Nairobi" 
UTM36s.proj <- "+proj=utm +zone=36 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs" # EPSG:32736
LatLong.proj <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"  # EPSG:4326
```

## Load Collar & Spatial Data
Using the dataset already cleaned and loaded into [R](https://cran.r-project.org/), we also load any spatial data layers that we want to include in the animation.  Here, we will subset the cleaned dataframe (`data.Mara`) and load a shapefile (`MMNR_UTM36S.shp`) of the Masai Mara National Reserve. 

```{r Animation Movement Data}
# Read GPS collar data, saved as an object in previous excercises
load("./Data/wildMara.Rdata")

# Subset to the animals to animate
unique(wild.Mara$individual.local.identifier)
data.Mara.An <- subset(wild.Mara, individual.local.identifier == "Naboisho" | individual.local.identifier == "Kayioni" | individual.local.identifier == "Nkairowua" | individual.local.identifier == "Ledama" | individual.local.identifier == "Nkoko" | individual.local.identifier == "Fifteen")
# Or, alternatively (same thing):
#data.Mara.An <- data.Mara %>% filter(individual.local.identifier == "Naboisho" | individual.local.identifier == "Kayioni" | individual.local.identifier == "Nkairowua" | individual.local.identifier == "Ledama" | individual.local.identifier == "Nkoko" | individual.local.identifier == "Fifteen")

# Load shapefile and Reproject to Lat/Long
# **************************************
# **************************************
Mara <- readOGR(dsn = "./Data/SpatialData", layer = "MMNR_UTM36S") 
Mara <- spTransform(Mara, CRS = CRS(LatLong.proj))

# Fortify object - helps to simplify the object for ggplot
mara.DF <- fortify(Mara)
```

## Convert to a Move Class Object
[MoveVis](https://cran.r-project.org/web/packages/moveVis/index.html) requires the animal movement trajectory to be converted to a [move](https://cran.r-project.org/web/packages/move/index.html) object. The function `move` accepts multiple different formats, including direct inputs from [Movebank](https://www.movebank.org/cms/movebank-main) and `ltraj` objects from `adehabitat`.  You can also directly specify the columns from a ".csv", using the `df2move` function in [moveVis](https://cran.r-project.org/web/packages/moveVis/index.html), which is simply a wrapper for the `move` function.  If you create a [move](https://cran.r-project.org/web/packages/move/index.html) object loaded directly from a .csv file, you *must* specify the projection.
 
```{r Animation Move Class, message=FALSE, warning=FALSE}
# Convert dataframe to move object
m <- df2move(data.Mara.An, x = "location.long", y = "location.lat", 
             time = "timestamp", 
             track_id = "individual.local.identifier", 
             proj = LatLong.proj,
             removeDuplicatedTimestamps = TRUE)

# Check time stamps and sampling rates (temporal resolution) of the trajectories:
#lag <- unlist(timeLag(m, unit = "mins"))

#summary(lag)
#median(lag)
#sd(lag)
```

## Prepare Data for Animation
In order to animate animals, [moveVis](https://cran.r-project.org/web/packages/moveVis/index.html) needs all locations across all incorporated trajectories to be aligned so that they share a uniform temporal resolution and uniform time stamps.  [MoveVis](https://cran.r-project.org/web/packages/moveVis/index.html) includes a dedicated function to align trajectories using linear interpolation (`align_move`).

```{r Animation Prepare, warning=FALSE}
# Aligning to a 1 day interval (or whatever makes sense for your data, just be aware of the amount of data included in the animation)
m <- align_move(m, res = 1, digit = 0, unit = "days")
print(paste0("How many days: ",length(unique(timestamps(m)))))

# Subset the dates so runs within a manageable time period.
m <- subset_move(m, from = mdy_hms("05-27-2010 03:00:00"), to = mdy_hms("08-31-2010 12:00:00"))

# check min and max of result
print(paste0("Minimum timestamp: ",min(timestamps(m))))
print(paste0("Maximum timsteamp: ",max(timestamps(m))))

# Create extent for animal (This can take some tweaking, based on the actual animal movements included).
# I'm increasing the extent slightly for visualization purposes
ext <- extent(m) * 1.15
ext@ymin <- ext@ymin * 1.05
ext@ymax <- ext@ymax + abs(ext@ymax * 0.05)
```

## Create Animation
[MoveVis](https://cran.r-project.org/web/packages/moveVis/index.html) then creates a sequence (list) of spatial movement frames/maps that are stitched together as a video. Numerous baselayer options are available. Here, we will animate the trajectories of 6 wildebeest on top of a static [OpenStreetMap](https://www.openstreetmap.org) basemap.Note that some of the basemaps (i.e., mapbox, carto) require an authentication key.  See `get_maptypes()` for other options. Many customs add-ons also exist, such as functions for including a unique title, scalebar, north arrow, and progress bar.

```{r Create Animation, warning=F}
# Create a sequence spatial movement maps, customizing the spatial extent, and specifying the map_service and map_type.
frames <- frames_spatial(m, trace_show = TRUE, equidistant = FALSE,
                         ext = ext, map_service = "osm",
                         map_type = "terrain_bg")

# See other basemap options available:
#get_maptypes()

# Add specific details to map, including title, timestamps, progress bar, north arrow, scalebar, and text.
frames <- frames %>% 
  add_labels(title = "White-bearded wildebeest (Connochaetes taurinus)", caption = "Map: OpenStreetMap/Terrain; Projection: Geographic, WGS84", 
                                x = "Longitude", y = "Latitude") %>%
  add_timestamps(type = "label") %>% 
  add_progress(colour = "white") %>%
  add_northarrow(colour = "white", position = "bottomleft") %>% 
  add_scalebar(colour = "black", position = "bottomright",
               distance = 10) %>%
  add_gg(gg=expr(geom_polygon(aes(x=long, y=lat), 
                               size=1, color="goldenrod", data=mara.DF, alpha=0)))

# Add text (Piping doesn't seem to work here)
frames <- add_text(frames, "Loita Plains", x = 35.583, y = -1.296,
                     colour = "black", size = 4) 
frames <- add_text(frames, "Mara Plains", x = 35.2, y = -1.21,
                   colour = "black", size = 4)
frames <- add_text(frames, "Maasai Mara National Reserve", x = 35.228, y = -1.58,
                   colour = "black", size = 4)

# Check to make sure everything is looking okay (important step because the animation processing time can be lengthy):
frames[[30]]
```

# Export Animation
As a last step, we will stitch the sequence of frames together using the `animate_frames()` function, outputing the individual frames as a GIF or video file.

```{r Animation Export, warning=FALSE}
# Additional file formats:
#suggest_formats()

# Create animation
animate_frames(frames, width = 1000, height = 1000, out_file = "Wildebeest_Example.mov", end_pause = 1, overwrite = TRUE)
```