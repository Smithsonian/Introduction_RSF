---
title: "Data Visualization & Summary"
author: "Jared Stabach, Smithsonian Conservation Biology Institute"
date: '`r format(Sys.time(), "%d %B %Y")`'
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: 
      collapsed: false
      smooth_scroll: true
    number_sections: false
    #theme: united
    #highlight: tango
pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<a href="https://github.com/Smithsonian/Wildebeest_RSF.git" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

# Introduction
Now that we have completed a first round of data cleaning edits, we can move forward with converting the dataframe to a spatial object.  This will allow us to summarize the dataset and visualize the movements patterns.  GPS (or Argos) data, however, are replete with positions of varying quality.  This is reported differently by each manufacturer, but likely includes some measure of the type of position (e.g., 1D, 2D, or 3D) and its quality (i.e., Dilution of Precision (DOP)).  Large DOPs indicate poor positional quality. In the steps that follow, we will:

* Plot DOP values
* Summarize fix success
* Visualize animal movement patterns

## Load Libraries
```{r Animation Libraries, message=FALSE, warning=FALSE}
# Remove everything from memory
rm(list=ls())

# Load required libraries
library(adehabitatLT)
library(ggplot2)
library(plyr)
library(proj4)

# TimeZone and Projection
Timezone1 <- "UTC"
Timezone2 <- "Africa/Nairobi" 
UTM36s.proj <- "+proj=utm +zone=36 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs" # EPSG:32736
LatLong.proj <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"  # EPSG:4326
```

## Load & Clean Movement Dataset
Load the cleaned movement dataset and use the quality flags included with the dataset to further remove erroneous data points. Since every manufacturer has different ways to evaluate error, you'll have to familiarize yourself with your own dataset.  Here, I have already removed the positions of low quality, using a simple filter to only include the best points.

```{r Summary Load Data}
# Read GPS collar data, saved as an object in previous excercises
load("./Data/wildMara.Rda")

# Plot the DOP values for confirmation.  Dataset already cleaned:
# For this dataset, the included identifying whether the position was 2D or 3D and then using a qualitative measure to remove poor positions
# I was more restrictive on 2D positions
# e.g., wild.Mara <- subset(wild.Mara, gps.fix.type.raw == "3D" & gps.dop < 10.0 | gps.fix.type.raw == "2D" & gps.dop < 5.0)
# Important to inspect your dataset an understand the fields included

ggplot(wild.Mara, aes(x=gps.dop))+
  geom_histogram(binwidth = 0.5, color="black")+
  #facet_grid(gps.fix.type.raw ~ .) + # Could separate out 2D and 3D here, but so few 2D points that graph doesn't plot well.
  labs(title="Dilution of Precision", x="Dilution of Precision (DOP)", "Count") + 
  theme_classic()
```

## Create Trajectory
[AdehabitatLT](https://cran.r-project.org/web/packages/adehabitatLT/index.html) is a great package for creating a 2D trajectory from movement data.  Many other packages (ie., [amt](https://cran.r-project.org/web/packages/amt/index.html)) can also be used.  Here, we will summarize the movements of each animal after converting the data from Lat/Long to UTM 36S so that we can calculate distances between steps.  

```{r Create Trajectory}
# Create matrix
temp <-as.matrix(cbind(wild.Mara$location.long,wild.Mara$location.lat))

# Project to UTM 36S (projection specified above) or other meter projection
xy <- project(temp, UTM36s.proj) # This uses the proj4 package
#plot(xy)

# Use the as.ltraj function to create individual animal trajectories. Use the infolocs command to included attributes of the dataframe.
traj.raw <-as.ltraj(xy,wild.Mara$timestamp,id = wild.Mara$id, typeII = TRUE, infolocs = wild.Mara[3:14], slsp = c("remove"))

# Notice that the dataset has no NAs.  This is because the function doesn't recognize the movement interval, something we must set.
# In our case, the data were collected: Every hour from 6 am to 6 pm and Every three hours from 6 pm to 6 am
# For the remainder of our exercises, we will treat these data as a 3 hour dataset

# Set reference date and use setNA to re-run trajectory
refda <- min(wild.Mara$timestamp)
traj.wild <- setNA(traj.raw, refda, dt = 3, units = "hour")

# Summarize Trajectory
Summary.traj <- summary(traj.wild)

# Add details
Summary.traj$DaysTrack <- signif(difftime(Summary.traj$date.end,Summary.traj$date.begin, units="days"),digits=2)
Summary.traj$Records <- Summary.traj$nb.reloc-Summary.traj$NAs
Summary.traj$PctComplete <- signif((Summary.traj$nb.reloc-Summary.traj$NAs)/Summary.traj$nb.reloc*100,digits=4)

# Look at again
Summary.traj

# Convert trajectory with movement statistics to a dataframe
traj.df <-ld(traj.wild)

# Calculate basic movement statistics
# REMEMBER: this is a 3 hour data.  Therefore, movements are simply based on the linear steps.
Mvmt.Statistics <- ddply(traj.df,"id", summarise,
              AvgMove = round(mean(dist/1000,na.rm=TRUE),digits=2), # Convert to km
              SumMove = round(sum(dist/1000,na.rm=TRUE),digits=2), # Convert to km
              MaxDisp=round(max(sqrt(R2n)/1000,na.rm=TRUE),digits=2)) # Convert to km
Mvmt.Statistics
```  

## Visualize Movement Patterns
[Adehabitat]() has a number of plotting options.  I use these sometimes, but usually prefer to create my own plots.  Here, I provide a simple example of the movement trajectory, with a "for loop" to plot each animal.  I find the net squared displacement plots and steplengths to be interesting to look at.

```{r Visualize}
# Plot trajectory using adehabitat
plot(traj.wild[1]) # Or plot(traj.wild) to view all animals

# We can also look at the DOP over time or the how the data were collected (every X minutes)
plotltr(traj.wild[1], "gps.dop") # Graphic of DOP over time......these should all be < 10, since we've cleaned them above
#plotltr(traj.wild[1],"dt/60") 

# My preference is to create a custom plot
# Setup a plotting layout with three panels
layout(matrix(c(1,1,2,3), 2, 2, byrow = FALSE), widths=1, heights=c(1,1))

# Here, we will "loop" over every individuals (by id)
Id.val <- unique(traj.df$id)

#for (i in 1:length(Id.val)){ # Here I've canceled the loop, just so the first individual prints
i <- 1
# ****************************** 

  # Remove the NAs and subset to id == Id.val[i]
  wild.sub <- subset(traj.df[!is.na(traj.df$x),], id == Id.val[i]) # This is just to account for NAs that have been added from as.ltraj function
  
  # Calculate the total days tracked
  time.diff <- trunc(difftime(format(wild.sub$date[1],tz=Timezone2),format(wild.sub$date[nrow(wild.sub)],tz=Timezone2),units="days"))
  
  # Create Titles for Plots
  Title1 = paste0(wild.sub$id[1]," Movement")
  Title3 = paste0("Steplengths")
  Title4 = paste0("Net Displacement")
  
  # Plot the trajectory
  plot(wild.sub$x,wild.sub$y,typ="l",xlab="Easting",ylab="Northing",main=Title1,frame=FALSE,axes=FALSE,asp=1)
     mtext(paste0(format(wild.sub$date[1],"%Y-%m-%d")," to ",format(wild.sub$date[nrow(wild.sub)],"%Y-%m-%d")),cex=0.75)
     axis(1, labels=TRUE)
     axis(2, labels=TRUE)
  points(wild.sub$x,wild.sub$y,pch=16,cex=0.5,col="blue")
  points(wild.sub$x[1],wild.sub$y[1],pch=17,cex=1,col="green")
  points(wild.sub$x[nrow(wild.sub)],wild.sub$y[nrow(wild.sub)],pch=15,cex=1,col="red")
  
  # Plot the movements over time (Velocity)
  plot(wild.sub$date, wild.sub$dist/1000, type='l', ylab="Distance moved (km)", xlab="Time", main=Title3, frame=FALSE)
    # Calculate the time from release date	
    mtext(paste0(abs(time.diff)," days"),cex=0.75)
  
  # Plot the net displacement per step
  plot(wild.sub$date, sqrt(wild.sub$R2n)/1000, type='l', ylab="Distance (km)", xlab="Days Since Release", main=Title4,frame=FALSE)
    mtext(paste0(abs(time.diff)," days"),cex=0.75)
#}
```